 
##   3.4.1: JavaScript Toolsets and Structure

## 3.4: JavaScript

Much like with our treatment of CSS, our purpose in the next few lessons isn't to make you an expert in JavaScript itself, but rather we'll be focusing primarily on the structure unique to Stencil and the appropriate entry points for your own code.

In this lesson, we'll look at the basics of how JavaScript is bundled and included in pages, as well as the concept of page type classes. 

> #### An Aside
> 
> To be perfectly accurate about the context of these topics, the conventions we'll be discussing surrounding JavaScript entry points are part of Cornerstone; they don't involve any agnostic components intrinsic to Stencil.

#### The Basics of Bundling

Stencil uses webpack for JavaScript bundling, minification and code splitting.

Webpack is a very large topic, and we're not going to delve very deeply into its configuration, but there are a few interesting things we can glean about our JavaScript entry points from the main config file. Examining the `webpack.common.js` file that comes pre-configured in Cornerstone (there are also `webpack.dev.js` and `webpack.prod.js` with environment-specific additions), these lines are among the contents:

```javascript
...
module.exports = {
    ...
    entry: {
        main: './assets/js/app.js',
        head_async: ['lazysizes'],
        font: './assets/js/theme/common/font.js',
        polyfills: './assets/js/polyfills.js',
    },
    ...
    output: {
        ...
        filename: 'theme-bundle.[name].js',
        path: path.resolve(__dirname, 'assets/dist'),
    },
    ...
};
```

There are several JS entry points defined, with source files located in `assets/js` (or imported directly from an npm package). The final "compiled" versions of these files will reside in `assets/dist/theme-bundle.main.js`. 

Turning our attention to the global layout template, `templates/layout/base.html`, we find these lines:

```html
...
<head>
    ...
    {{> components/common/polyfill-script }}
    ...
    <script async 
        src="{{cdn 'assets/dist/theme-bundle.head_async.js' 
            resourceHint='preload' 
            as='script'}}"
    ></script>
    ...    
    <script async 
        src="{{cdn 'assets/dist/theme-bundle.font.js' 
            resourceHint='preload' 
            as='script'}}"
    ></script>
    ...
</head>
<body>
    ... (Main body content)
    <script async defer 
        src="{{cdn 'assets/dist/theme-bundle.main.js' 
            resourceHint='preload' 
            as='script'}}" 
        onload="onThemeBundleMain()"></script>
    ...
</body>
...
```

The `theme-bundle.polyfills.js` file is loaded as needed in the `polyfill-script` component. Aside from that, we see that the other "entry point" JS files are loaded directly with `<script>` elements in the layout.

Most of these entry point files do their jobs invisibly, and you don't need to concern yourself with them. The source file `assets/js/app.js` (bundled with its dependencies into `theme-bundle.main.js`) is the primary entry point worthy of attention. This file sets up the JS "application" on every page by importing and running certain global scripts, defining the logic for loading page-specific entry points, and establishing mappings of page types to those entry points.

Any "global" JavaScript you need to add to your storefront should likely be injected in `app.js` or, more cleanly if feasible, in the class this file imports from `assets/js/theme/global.js`.

#### Page Type Classes

While `app.js` imports a great deal of common code and is the source for the "main" JS bundle included on every page, much of the JavaScript code operative in Cornerstone is specific to the type of page being loaded. Such code is bundled separately and loaded only on relevant pages.

Once again examining `base.html`, observe the following:

```html
<body>
    ...
    <script>
        {{!-- Exported in app.js --}}
        function onThemeBundleMain() {
            window.stencilBootstrap(
                "{{page_type}}", 
                {{jsContext}}
            ).load();
        }
    </script>
    ...
</body>
```

This snippet, executed after `theme-bundle.main.js` is loaded, calls a "bootstrap" method, passing in the `page_type` from the Stencil context as well as an object called `jsContext`.

You can pore over the loading logic for `stencilBootstrap` in `app.js` if you like, but the real key to understanding page-specific entry points, from the same file, is in the `pageClasses` mapping:

```javascript
...
const getAccount = () => import('./theme/account');
const getLogin = () => import('./theme/auth');
const noop = null;

const pageClasses = {
    account_orderstatus: getAccount,
    account_order: getAccount,
    ...
    createaccount: getLogin,
    ...
    brands: noop,
    ...
    category: () => import('./theme/category'),
    ...
    product: () => import('./theme/product'),
    ...
};
...
```

This is just a small sample from the mapping, but the concept should be clear: Each possible `page_type` string is mapped to an import function responsible for loading the correct JS module from a source file in `assets/theme`. (Some page types, like "brands", import no module at all by default, having no need of custom JS code.)

The page type classes contained in these individual JS files each extend `PageManager`, a lean class that mainly stores a context object and defines an `onReady` method that executes automatically when the DOM is ready. Even the class in the aforementioned `assets/js/theme/global.js` extends this ancestor class, so any logic you need to kick off on every page would simply be added in the `onReady` method in that file.

Most of the time, adding custom JavaScript in your storefront will be a matter of identifying the appropriate page type class, or creating a new one extending `PageManager` and updating the mapping in `app.js`, and using `onReady` as your initial entry point to set up appropriate event handlers, etc.

#### Quick Exercise: Add a Home Page Class

This short exercise is just meant to demonstrate the page mapping concept; you can plan to throw the code away after we're done, so whether to follow along is up to you.

If you browse to your store's home page in your local Stencil environment and inspect the JS sources, you'll see that these include the files we saw loaded explicitly in `base.html` and little else. So what about the page-specific JS bundle applicable to the home page?

[](https://courseassets.swiftotter.com/bc-frontend-foundations/images/home-page-js.png)

[![](https://courseassets.swiftotter.com/bc-frontend-foundations/images/home-page-js.png)](https://courseassets.swiftotter.com/bc-frontend-foundations/images/home-page-js.png)

[](https://courseassets.swiftotter.com/bc-frontend-foundations/images/home-page-js.png)

To investigate further, we need to know the `page_type` actually used by the home page, which is a perfect opportunity to practice inspecting the Stencil context object via the `debug` querystring parameter and your favorite debugging method.

You should find this:

```json
{
    ...
    "page_type": "default",
    ...
}
```

Try cross-referencing the "default" type with the mapping in `app.js`, and you'll find that this is one of the types mapped to `noop` (essentially just an alias to a null value).

```javascript
const pageClasses = {
    ...
    default: noop,
    ...
};
```

Cornerstone does not, apparently, implement any custom JavaScript for the home page. Let's change that!

First we'll need a page type class to load. Create `assets/js/theme/home.js`with a very simple class extending `PageManager`:

```javascript
import PageManager from './page-manager';

export default class Home extends PageManager {
    onReady() {
        console.log("Hello world from the home page!");
    }    
}
```

Then update `app.js` with the appropriate `import` function:

```javascript
const pageClasses = {
    ...
    default: () => import('./theme/home'),
    ...
};
```

Once your home page reloads, you should find not only that you've successfully hooked into the right entry point to make your `console.log`execute on this page, but that your JS sources now include a new unique bundle file.

[](https://courseassets.swiftotter.com/bc-frontend-foundations/images/home-page-js-extra.png)

[![](https://courseassets.swiftotter.com/bc-frontend-foundations/images/home-page-js-extra.png)](https://courseassets.swiftotter.com/bc-frontend-foundations/images/home-page-js-extra.png)